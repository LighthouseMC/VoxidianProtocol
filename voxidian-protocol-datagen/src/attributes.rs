use proc_macro2::TokenStream;

use crate::{format_token_stream, reports::get_reports_json};

pub fn make_attrs() {
    let json = make_attrs_to_json();
    let tokens = make_attrs_tokens(json);
    let fmt = format_token_stream(&tokens);

    std::fs::write("../src/autogenerated/attribute_types.rs", fmt).unwrap();
}

pub(crate) fn make_attrs_to_json() -> Vec<(String, u32)> {
    let mut registries = get_reports_json();
    let items = registries.map.get_mut("minecraft:attribute").unwrap();
    let mut vc = items.entries
        .iter()
        .map(|(name, entry)| {
            (name.clone(), entry.protocol_id)
        })
        .collect::<Vec<_>>();
    vc.sort_by_key(|x| x.1);
    vc
}

pub fn make_attrs_tokens(item_entries: Vec<(String, u32)>) -> TokenStream {
    let mut stream = TokenStream::new();
    for entry in item_entries {
        let name = entry.0.replace("minecraft:", "");
        stream.extend(quote::quote! {
            registry.insert(Identifier::vanilla_const(#name), AttributeType { id: Identifier::vanilla_const(#name) });
        });
    }
    quote::quote! {
        use crate::packet::*;

        impl AttributeType {
            #[allow(dead_code)]
            #[allow(redundant_semicolons)]
            pub fn vanilla_registry() -> Registry<AttributeType> {
                let mut registry = Registry::new();
                #stream
                registry
            }
        }
    }
}